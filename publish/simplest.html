<!DOCTYPE html>
<br lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title> Live Stream (Cluster)</title>
    <link rel="stylesheet" type="text/css" href="css/table.css"/>
    <!--<link rel="stylesheet" type="text/css" href="css/main.css"/>-->
    <style>
        button {
            width: 100px;
            display:inline-block;
            padding-bottom: 10px;
            padding-top: 10px;
            margin: 0px 0px 5px 05px;
            border-radius:4px;
            border: 1px solid transparent;
            background-color: #5bc0de;
            border-color: #46b8da;
            color: white;
        }
        button[disabled] {
            background-color: #d9534f;
            border-color: #d43f3a;
        }
        input {
            height:20px;
            /*width:300px;*/
            padding:5px 8px;
            font-size: 14px;
        }

    </style>

</head><br>
<script type="text/javascript" src="lib/jquery-latest.min.js"></script>
<script type="text/javascript">
    window.onload = load;
    function load() {
        var ws; // websocket連線
        var gg = 0;
        var videoUri = document.getElementById('input1');
        var code = 'fxlive.op';
        var callback = undefined;
        function liveStream(url, cb) {
            callback = cb;

            if (url) { wsURL = url}

            ws = new WebSocket(wsURL,[code]);
            ws.binaryType = "arraybuffer";
            ws.name = "ws_"+ (++gg);
            ws.startTime = new Date();
            ws.bUrl = url;
            ws.onopen = onOpenHandle;
            ws.onclose = onCloseHandle;
            ws.onmessage = onMessageHandle;
            ws.onLogin = false;
            ws.onTakeMachine = false;

            return ws;

        }
        function trace(str) {
            $('#content').append('<p>' + str + '</p>');
        }
        function onCloseHandle(evt) {
            console.log('>>> websocket on disconnect.');
            $('#content').append('<p>[' + ws.startTime.getHours()+ ':' + ws.startTime.getMinutes() + '] WebSocket on Disconnect.(' + ws.bUrl + ')</p>');
            if (callback) callback(0);
        }
        function onOpenHandle(evt){
            console.log('websocket on connected.', ws.extensions, ws.name);
            $('#content').append('<p>[' + ws.startTime.getHours()+ ':' + ws.startTime.getMinutes() + '] WebSocket on Connected.(' + ws.bUrl + ')</p>');

            if (callback) callback(1);
        }

        var sid = "67191b528043b3c7a05876ddc2e42012ffcbeb40";
        var game_type = "5902";


        function onMessageHandle(evt) {
            var str;
            if (code != 'fxlive.op') {
                var src = String.fromCharCode.apply(null, new Uint8Array(evt.data));
                str = Utf8ArrayToStr(new Uint8Array(evt.data));
            }else {
                str = evt.data;
            }

//            return;


            var self = this;
            // return;

//            if (evt.data.substr(0,2) != '"{') return;

            var json = JSON.parse(str);

            if (json.NetStatusEvent === "NetConnect.Success") {

            }else if(json.NetStatusEvent === "Connected.amfIsReady") {
                ws.send(JSON.stringify({'event':'setUser','data':[{hallID:6, site: "member"}]}));
                setTimeout(function () {
                    ws.send(JSON.stringify({'event':'setSid','data':['4d88f4ba542c857fc8b3c070ad11b12402e6f48b']}));
                },500)
//                ws.send(JSON.stringify({"lang":"tw","vType":"ws","dev":"Desktop","gameType":3001,"gameCode":3,"sid":"d36f7538210882a63c1b6cb5aa9ce2c1eee99061","action":"login"}));
            }
            else if( json.cmd === "onChkIp") {
//                ws.send(JSON.stringify({'event':'loginBySid','data':['8ea5ffab184f81d94e0f1a0ad7d2631ccc9ee8f4',1]}));
            }
            else if(json.NetStatusEvent === "Data"){

                if(json.args[0].action == 'onLogin') {
                    console.log('onlogin');

                    ws.send(JSON.stringify({"gameType":3001,"gameCode":1,"sid":"8ea5ffab184f81d94e0f1a0ad7d2631ccc9ee8f4","action":"userInfo"}));

//                    ws.send(JSON.stringify({"gameType":3001,"gameCode":3,"sid":"8ea5ffab184f81d94e0f1a0ad7d2631ccc9ee8f4","action":"userInfo"}));
                    setTimeout(function () {
                        ws.send(JSON.stringify({"gameType":3001,"gameCode":1,"sid":"8ea5ffab184f81d94e0f1a0ad7d2631ccc9ee8f4","action":"tableList"}));
                    },2000);
                    setTimeout(function () {
                        ws.send(JSON.stringify({"gameType":3001,"gameCode":3,"sid":"8ea5ffab184f81d94e0f1a0ad7d2631ccc9ee8f4","action":"videoLink"}));
                    },4000)
                }
            }
            else{
            }
            console.log(json.action);
            switch (json.action) {
                case "ready": {

                    setTimeout(function () {
                        var str = JSON.stringify({"action":"loginBySid","sid":sid,"gtype":game_type});
                        self.send(binEncode(str));
                    },100);
                    break;
                }
                case "onTakeMachine": {

                    if (json.result.event == true) self.onTakeMachine = true;

                    if (self.onLogin && self.onTakeMachine){
                        setTimeout(function () {
                            var str = JSON.stringify({"action":"onLoadInfo2"});
                            self.send(binEncode(str));
                        },1000);

                    }

                    break;
                }
                case "onLogin":{
                    self.onLogin = true;
                    if (self.onLogin && self.onTakeMachine) {
                        setTimeout(function () {
                            var str = JSON.stringify({"action":"onLoadInfo2"});
                            self.send(binEncode(str));
                        },1000);
                    }
                    break;
                }
                case "onOnLoadInfo2": {

                    setTimeout(function () {
//                        self.send(JSON.stringify({"action":"getMachineDetail"}));
                        var str = JSON.stringify({"action":"creditExchange","rate":"1:10","credit":50000});
                        self.send(binEncode(str));
                    },1000);
                    break;
                }
                case "onGetMachineDetail": {
                    self.send(binEncode(JSON.stringify({"action":"creditExchange","rate":"1:10","credit":"50000"})));
                    setTimeout(function () {

                    },1000);
                    break;
                }
                case "onCreditExchange": {
                    setTimeout(function () {
                        self.send(binEncode(JSON.stringify({"action":"beginGame2","line":1,"lineBet":50})));

                    },1000);
                    break;
                }
                case "onBeginGame": {
                    setTimeout(function () {
                        self.send(binEncode(JSON.stringify({"action":"beginGame2","line":1,"lineBet":50})));
                    },3000);
                    break;
                }
                case "onBeginGame2": {
                    console.log("json.action:", JSON.stringify(json));
                    var wagersID = json["result"]["data"]["wagersID"];
                    function run(id) {

                        setTimeout(function () {
                            self.send(binEncode(JSON.stringify({"action":"endGame","sid":sid,"wagersID":id})));
                            self.send(binEncode(JSON.stringify({"action":"betInfolog","bs":1,"betInfo":{"status":"endGame","wagersID":id,"credit":"499600.00"}})));
                        },3000);
                    }
                    run(wagersID);
                    break;
                }
                case "onEndGame": {
                    setTimeout(function () {
                        self.send(binEncode(JSON.stringify({"action":"beginGame2","line":"5","lineBet":10})));
                    },1000);
                    break;
                }



            }



        }
        var liveList = [];

        for (var i = 0; i < liveList.length; i++) {
            var obj = liveList[i];
            var button = document.getElementById(obj);

            switch (i) {
                case 0:
                    button.onclick = onClickHandle;
                    break;
                case 1:
                    button.onclick = onClickHandleStop;
                    break;
                case 2:
                    button.onclick = onAutoSendHandle;

            }
        }
        function onClickHandle(e) {
            liveStream();
        }
        function onClickHandleStop(e) {
//            ws.send(JSON.stringify({action:"userInfo"}));
            console.log('click close');

        }
        var auto = undefined;
        function onAutoSendHandle(e) {

            if (auto){
                console.log('click');
                clearInterval(auto);
                auto = undefined;
            }else {
                auto = setInterval(function () {
                    ws.send(JSON.stringify({
                        event:'Send',
                        data:'1234'
                    }));
                },5000);
            }

        }

        $( "#inputTest" ).click(function() {
            $('#content').empty();
//            ws.close();
            liveStream('ws://'+ $('#IPAddress').val() +":"+ $('#Port').val() + $('#Path').val());
        });


        var td_scheduled = '<td class="t-status t-scheduled">Scheduled</td>';
        var td_unknown = '<td class="t-status t-unknown">Starup</td>';
        var td_inactive  = '<td class="t-status t-inactive">Inactive</td>';
        var td_offline  = '<td class="t-status t-offline"Offline</td>';
        var td_active    = '<td class="t-status t-active">Active</td>';
        var td_online    = '<td class="t-status t-online">Online</td>';
        var td_draft     = '<td class="t-status t-draft">Draft</td>';
        var host = "127.0.0.1:8000";
        var path = "/fxCasino/fxLB?gameType=5906";
        var info = "locale";


        var lists = [
            {
                host:'43.251.76.236',
                path:"/fxCasino/fxLB?gameType=5904",
                info:'開發站-slot+loadbalance'
            },{
                host:'43.251.76.236',
                path:"/fxCasino/fxLB?gameType=5096",
                info:'開發站-slot'
            },{
                host:'43.251.76.236',
                path:"/fxlive/Hall/service.h1",
                info:'開發站-大廳'
            },{
                host:'43.251.76.219',
                path:"/fxlive/FigLeaf/BigBall1",
                info:'QA站測試'
            },{
                host:'bm.vir999.com',
                path:"/fxlive/BacPlayerLight/h1",
                info:'QA站測試'
            },{
                host:'43.251.69.32',
                path:"/fxCasino/fxLB?gameType=5904",
                info:'正式站測試'
            },{
                host:'bm.test.04vip.net',
                path:"/fxlive/SicBoPlayerBM/h1",
                info:'正式站測試'
            },{
                host:'127.0.0.1:10082',
                path:"/hall",
                info:'本地測試'
            },{
                host:'127.0.0.1:8000',
                path:"/fxlive/BacPlayerLight/h1",
                info:'本地測試'
            },{
                host:'127.0.0.1:8000',
                path:"/fxlive/Hall/service.h1",
                info:'本地測試'
            }
        ];
        for (var i = 0; i < lists.length; i++) {
            additems(lists[i]);
        }

        function additems(opt) {

            $("#srv-list > tbody:last").append('' +
                    '<tr id="tr3"><td><input type="button" class="testSrvBtn"></td>' +
                    '<td contenteditable="true" style="user-modify:read-write-plaintext-only;">' + opt.host + '</td>' +
                    '<td contenteditable="true" style="user-modify:read-write-plaintext-only;">' + opt.path + '</td>' +
                    '<td>' + opt.info + '</td>' +
                    td_unknown +
                    '</tr>');
        }

        console.log($("#tr3").find('td:eq(1)').html());
        console.log($("#tr3").find('td:eq(2)').html());
//        $('td').remove(":eq(4)");
//        $("#srv-list tr:eq(1)").append("<td>New Column</td>");


        $( ".testSrvBtn" ).click(function() {
            var td = $(this).parent();
            var tr = td.parent();
            console.log(tr.find('td:eq(1)').html());
            var url = 'ws://' + tr.find('td:eq(1)').html() + tr.find('td:eq(2)').html();

            liveStream(url, function (state) {
                tr.find('td:eq(4)').remove();
                if (state) {
                    tr.append(td_active);
                }else
                {
                    tr.append(td_inactive);
                }
            });
//            setInterval(function () {
//                var ws = liveStream(url, function (state) {
//                });
//            },1)

        });


        var lines = $('#script').val().split('\n');
        console.log(lines);
        for(var i = 0;i < lines.length;i++){
//            console.log(lines[i]);
            var str = $.trim(lines[i]);
            var arr = str.split(";");
            if (typeof arr[0] != "undefined" && arr[0] != "") {
                console.log(JSON.parse(arr[0]));

            }
        }


        function Utf8ArrayToStr(array) {
            var out, i, len, c;
            var char2, char3;

            out = "";
            len = array.length;
            i = 0;
            while(i < len) {
                c = array[i++];
                switch(c >> 4)
                {
                    case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:
                    // 0xxxxxxx
                    out += String.fromCharCode(c);
                    break;
                    case 12: case 13:
                    // 110x xxxx   10xx xxxx
                    char2 = array[i++];
                    out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
                    break;
                    case 14:
                        // 1110 xxxx  10xx xxxx  10xx xxxx
                        char2 = array[i++];
                        char3 = array[i++];
                        out += String.fromCharCode(((c & 0x0F) << 12) |
                            ((char2 & 0x3F) << 6) |
                            ((char3 & 0x3F) << 0));
                        break;
                }
            }

            return out;
        }
        function binEncode(str){
            var n = str.length,
                idx = -1,
                byteLength = 512,
                bytes = new Uint8Array(byteLength),
                i, c, _bytes;

            for(i = 0; i < n; ++i){
                c = str.charCodeAt(i);
                if(c <= 0x7F){
                    bytes[++idx] = c;
                } else if(c <= 0x7FF){
                    bytes[++idx] = 0xC0 | (c >>> 6);
                    bytes[++idx] = 0x80 | (c & 0x3F);
                } else if(c <= 0xFFFF){
                    bytes[++idx] = 0xE0 | (c >>> 12);
                    bytes[++idx] = 0x80 | ((c >>> 6) & 0x3F);
                    bytes[++idx] = 0x80 | (c & 0x3F);
                } else {
                    bytes[++idx] = 0xF0 | (c >>> 18);
                    bytes[++idx] = 0x80 | ((c >>> 12) & 0x3F);
                    bytes[++idx] = 0x80 | ((c >>> 6) & 0x3F);
                    bytes[++idx] = 0x80 | (c & 0x3F);
                }
                if(byteLength - idx <= 4){
                    _bytes = bytes;
                    byteLength *= 2;
                    bytes = new Uint8Array(byteLength);
                    bytes.set(_bytes);
                }
            }
            return bytes.subarray(0, ++idx);
        }
        function utf16to8(str) {
            var out, i, len, c;

            out = "";
            len = str.length;
            for(i = 0; i < len; i++) {
                c = str.charCodeAt(i);
                if ((c >= 0x0001) && (c <= 0x007F)) {
                    out += str.charAt(i);
                } else if (c > 0x07FF) {
                    out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));
                    out += String.fromCharCode(0x80 | ((c >>  6) & 0x3F));
                    out += String.fromCharCode(0x80 | ((c >>  0) & 0x3F));
                } else {
                    out += String.fromCharCode(0xC0 | ((c >>  6) & 0x1F));
                    out += String.fromCharCode(0x80 | ((c >>  0) & 0x3F));
                }
            }
            return out;
        }
        function unicode2utf8_uint8array(str){
            var n = str.length,
                idx = -1,
                byteLength = 512,
                bytes = new Uint8Array(byteLength),
                i, c, _bytes;

            for(i = 0; i < n; ++i){
                c = str.charCodeAt(i);
                if(c <= 0x7F){
                    bytes[++idx] = c;
                } else if(c <= 0x7FF){
                    bytes[++idx] = 0xC0 | (c >>> 6);
                    bytes[++idx] = 0x80 | (c & 0x3F);
                } else if(c <= 0xFFFF){
                    bytes[++idx] = 0xE0 | (c >>> 12);
                    bytes[++idx] = 0x80 | ((c >>> 6) & 0x3F);
                    bytes[++idx] = 0x80 | (c & 0x3F);
                } else {
                    bytes[++idx] = 0xF0 | (c >>> 18);
                    bytes[++idx] = 0x80 | ((c >>> 12) & 0x3F);
                    bytes[++idx] = 0x80 | ((c >>> 6) & 0x3F);
                    bytes[++idx] = 0x80 | (c & 0x3F);
                }
                if(byteLength - idx <= 4){
                    _bytes = bytes;
                    byteLength *= 2;
                    bytes = new Uint8Array(byteLength);
                    bytes.set(_bytes);
                }
            }
            return bytes.subarray(0, ++idx);
        }
    }
</script>

<label class="textareaContainer"></label>

    <div id ='content' style="height:200px;width:auto;border:1px solid #ccc;font:10px Georgia, Garamond, Serif;overflow:auto;"></div>

    <table class="table table-action" id="srv-list">

        <thead>
        <tr>
            <th class="t-small"></th>
            <th class="t-small">IP</th>
            <th class="t-high">Path</th>
            <th >Info</th>
            <th class="t-medium">State</th>
        </tr>
        </thead>

        <tbody>

        </tbody>
    </table>

            <textarea id ='script' rows="20"  style="height:200px;width:100%;font:16px/26px Georgia, Garamond, Serif;">
            {"action":"loginBySid","sid":"4cb494cce1cdae5470d369eeaf83c9f71b42512a","gtype":"5902"}; 100ms
            {"action":"onLoadInfo2"}; 200ms
            {"action":"creditExchange","rate":"1:1","credit":50000}; 300ms
            {"action":"beginGame2","line":"5","lineBet":10}; 400ms
            </textarea>
</body>
</html>