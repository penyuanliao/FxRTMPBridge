<!DOCTYPE html>
<br lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title> Live Stream (Cluster)</title>
    <style>
        button {
            width: 100px;
            display:inline-block;
            padding-bottom: 10px;
            padding-top: 10px;
            margin: 0px 0px 5px 05px;
            border-radius:4px;
            border: 1px solid transparent;
            background-color: #5bc0de;
            border-color: #46b8da;
            color: white;
        }
        button[disabled] {
            background-color: #d9534f;
            border-color: #d43f3a;
        }
        input {
            height:20px;
            /*width:300px;*/
            padding:5px 8px;
            font-size: 14px;
        }

    </style>

</head><br>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<!--<script type="text/javascript" src="project.js"></script>-->
<script type="text/javascript" src="studios.js"></script>
<script type="text/javascript" src="lib/vp6StremData.js"></script>
<script type="text/javascript" src="lib/hexstring.js"></script>
<script type="text/javascript">

    var str = getFLVDataInBase64();


    var HEAP8 = Module.HEAP8;
    var HEAPU8 = Module.HEAPU8;
    var HEAP16 = Module.HEAP16;
    var HEAP32 = Module.HEAP32;

    var MAX_STREAM_BUFFER_LENGTH = 1024 * 1024;

    function toU8Array(ptr, length) {
        return HEAPU8.subarray(ptr, ptr + length);
    };

    $(function() {
        console.log('init ready');
//        var VP62 = Module.cwrap('VP62_NewStream');
        var api = Module._init();

        var data = toUint8Array(str);
        console.log(data);

        var buf = Module._malloc(MAX_STREAM_BUFFER_LENGTH);
        HEAPU8.set(data, buf);

        Module._apiDecDecode(api, buf, data.length);

        var ptr = Module._malloc(942080);

        var result = Module._apiDecNextPicture2(api, ptr);

        var imgBuf = Module.HEAPU8.subarray(ptr, ptr + 942080);

        console.log(imgBuf[0],imgBuf[1],imgBuf[2]);


        var jsInput_U8Buf = new Uint8Array(10);
        var inputMemory = Module._malloc(jsInput_U8Buf.length * jsInput_U8Buf.BYTES_PER_ELEMENT);
        jsInput_U8Buf[0] = 0x12;
        jsInput_U8Buf[1] = 0x13;
        jsInput_U8Buf[2] = 0x14;
        jsInput_U8Buf[3] = 0x15;
        jsInput_U8Buf[4] = 0x16;

        Module.HEAPU8.set(jsInput_U8Buf, inputMemory); //複製資料,長度以jsInput_U8Buf作為資料長度

        var outputMemory = Module._malloc(10);
        var samplest = Module._memInToOut(inputMemory, outputMemory, 10);

        //C Memory copy Javascript buffer
        var outputBuffer = Module.HEAPU8.subarray(outputMemory, outputMemory + 10);

        console.log(outputBuffer[0],outputBuffer[1],outputBuffer[2],outputBuffer[3],outputBuffer[4]);
        console.log(0x12,0x13,0x14,0x15,0x16);


        var c = document.getElementById("myCanvas");
        var ctx = c.getContext("2d");
        var pixels = new Uint8ClampedArray(imgBuf);
        var imageData = ctx.createImageData(640, 368);   /// create a canvas buffer (RGBA)
        var data = imageData.data;                   /// view for the canvas buffer
        var len = data.length;                       /// length of buffer
        var i = 0;                                   /// cursor for RGBA buffer
        var t = 0;                                   /// cursor for RGB buffer
        for(; i < len; i += 4) {
            data[i + 2]     = pixels[t];     /// copy RGB data to canvas from custom array
            data[i + 1] = pixels[t + 1];
            data[i] = pixels[t + 2];
            data[i + 3] = pixels[t + 3];           /// remember this one with createImageBuffer
            t += 4;
        }

        ctx.putImageData(imageData, 0, 0); /// put data to canvas

    });

</script>



<script type="application/javascript">

    var sample = [ {a1: 'this a1 1234567890',
        a2: [ 1, 2, 3, '1', '1' ],
        a3: { name: '1' },
        a4: 123 }];

</script>
<script type="text/javascript">
    window.onload = load;
    function load() {
        var ws; // websocket連線

        var videoUri = document.getElementById('input1');

        function liveStream(url) {

//            var wsURL = 'ws://' + '43.251.76.111:80/BacPlayerLight/g1';
//            var wsURL = 'ws://' + '43.251.76.111:80/fxCasino/slotFX'

//            var wsURL = 'ws://' + '103.252.213.44:80/slotFX';
//            var wsURL = 'ws://' + 'bm.vir999.net/fxCasino/slotFX';//qa
//            var wsURL = 'ws://' + '183.182.74.182:443/fxlive/BacPlayerLight/g1';
//            var wsURL = 'ws://' + '127.0.0.1:8000/fx/BacPlayerLight/g1';
//            var wsURL = 'ws://' + '127.0.0.1:8000/fxCasino/slotFX?gemeType=1521';
//            var wsURL = 'ws://' + 'bm.test.04vip.com/fxCasino/BacPlayerLight/g1';// 正式站
//            var wsURL = 'ws://' + '43.251.76.26:80/fxLive/BacPlayerLight/g1';
//            var wsURL = 'ws://' + '127.0.0.1:8000/fxLive/BacPlayerLight/g1';
//            var wsURL = 'ws://' + '43.251.76.111/fxLive/fxLB'; //picture
//            var wsURL = 'ws://' + '127.0.0.1:8000/fxLive/Hall/service.webAsia2'; //hall
//            if (videoUri.value != "") wsURL = videoUri.value;

            if (url) { wsURL = url};

            ws = new WebSocket(wsURL);
            ws.bUrl = url;
            ws.onopen = onOpenHandle;
            ws.onclose = onCloseHandle;
            ws.onmessage = onMessageHandle;

        }
        function onCloseHandle(evt) {
            console.log('>>> websocket on disconnect.');
            $('#content').append('<p>WebSocket on Disconnect.' + ws.bUrl + '</p>');
        }
        function onOpenHandle(evt){
            console.log('websocket on connected.');

            $('#content').append('<p>WebSocket on Connected.' + ws.bUrl + '</p>');

//            ws.send('/reboot');
//            setInterval(function () {
//                ws.send('10000');
//            },1000)
        }
        function onMessageHandle(evt) {
            return;
            var json = JSON.parse(evt.data);
            if (json.NetStatusEvent === "NetConnect.Success") {
            }else if(json.NetStatusEvent === "Connected.amfIsReady") {

                  ws.send(JSON.stringify({'event':'setHallID','data':[32]}));
                ws.send(JSON.stringify({'event':'loginBySid','data':['f9a50f57dbc483f24ed92d4e341a856a6208c50a',1]}));
//                ws.send(JSON.stringify({"lang":"tw","gameType":3001,"gameCode":3,"sid":"c089125298394ba36c480895d2b21a64671e9f49","action":"login"}));
            }
            else if( json.cmd === "onChkIp") {
//                ws.send(JSON.stringify({'event':'loginBySid','data':['f9a50f57dbc483f24ed92d4e341a856a6208c50a',1]}));
            }
            else if(json.NetStatusEvent === "Data"){

                if(json.args[0].action == 'onLogin') {
                    console.log('onlogin');
                    ws.send(JSON.stringify({"gameType":3001,"gameCode":3,"sid":"c089125298394ba36c480895d2b21a64671e9f49","action":"userInfo"}));
                    setTimeout(function () {
                        ws.send(JSON.stringify({"gameType":3001,"gameCode":3,"sid":"c089125298394ba36c480895d2b21a64671e9f49","action":"tableList"}))
                    },2000);
                    setTimeout(function () {
                        ws.send(JSON.stringify({"gameType":3001,"gameCode":3,"sid":"c089125298394ba36c480895d2b21a64671e9f49","action":"videoLink"}))
                    },4000)
                }
            }
            else{
            }
            console.log(json.data);


        }
        var liveList = ["live1","live2","autoSend"];

        for (var i = 0; i < liveList.length; i++) {
            var obj = liveList[i];
            var button = document.getElementById(obj);

            switch (i) {
                case 0:
                    button.onclick = onClickHandle;
                    break;
                case 1:
                    button.onclick = onClickHandleStop;
                    break;
                case 2:
                    button.onclick = onAutoSendHandle;

            }
        }
        function onClickHandle(e) {
            liveStream();
        }
        function onClickHandleStop(e) {
//            ws.send(JSON.stringify({action:"userInfo"}));
            console.log('click close');
            ws.close();
        }
        var auto = undefined;
        function onAutoSendHandle(e) {

            if (auto){
                console.log('click');
                clearInterval(auto);
                auto = undefined;
            }else {
                auto = setInterval(function () {
                    ws.send(JSON.stringify({
                        event:'Send',
                        data:'1234'
                    }));
                },5000);
            }

        }

        $( "#inputTest" ).click(function() {
            $('#content').empty();
//            ws.close();
            liveStream('ws://'+ $('#IPAddress').val() +":"+ $('#Port').val() + $('#Path').val());
        });
    }
</script>

        <button id="live1" class="button" >start</button>
        <button id="live2" class="button" >stop</button>
        <div>
            <button id="autoSend" class="button" >autoSend</button>
        </div>
        <div>
        </div>

        <input id="IPAddress" type="text" value="127.0.0.1" size="25"/>
        <input id="Port" type="text" value="8000" size="6"/>
        <input id="Path" type="text" value="/fxLive/BacPlayerLight/g1" size="25"/>
        <input id="SID" type="text" value="" size="25"/>
        <button id="inputTest" class="button" >inputTest</button>
    </div>
    <div id ='content'></div>


    <canvas id="myCanvas" width="640" height="480" style="border:1px solid #d3d3d3;"/>
</body>
</html>